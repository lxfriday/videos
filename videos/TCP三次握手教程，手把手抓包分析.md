# TCP 三次握手教程，手把手抓包分析

- [前往视频](https://www.bilibili.com/video/BV1b14y1H77J)

关于 TCP 三次握手和四次挥手
各位程序员兄弟们
在读大学的时候
或者是在面试的时候绝对碰到过
说它难呢也不算太难
但是非常容易忘记
今天就通过 wireshark 抓包
来分析一下
TCP 的三次握手和四次挥手
兄弟们
因为本人也不是网络专业的人啊
要是内容有错误的话
wireshark 是一个非常全面的抓包工具
这个软件可能很多人都听说过啊
但是对它比较陌生
用这个软件可以分析
TCP 连接时候的交互过程
像 SYN ACK seq 这些都可以比较清楚的看到
那我们对 TCP 的分析
就能够更明白一些
另外像 HTTPS 握手的过程
这里也显示的非常详细
各种教程里面都有提到的
client hello、server hello
这里都有显示
总之呢
这个软件做分析的时候非常有用啊
面试的时候
面试官想考你网络相关内容的话
这个问题基本上必然会被问到
TCP 的三次握手由客户端发起
客户端传输的报文信息里面
SYN 标志位为 1
同时会携带一个 seq 的序列号
在 wireshark 里面也可以看到
第一次握手的时候
只有一个 SYN 标志位
而它的 seq 相对序列号是 0
下面还有一个 raw sequence number
这个 sequence number 是实际的序列号
下面的两个 acknowledgement number
在第二次握手的时候
服务端的响应报文中
SYN 和 ACK 标志位都置为了 1
而这两个标志位实际对应的值
一个是 y
一个是 x+1
这个地方
ack 实际的值
必须是前面第一次握手时候的 seq 的值加上 1
在 wireshark 中
第二次握手返回的 raw seq number 和 raw ack number 都有值
这个 ack number
刚好等于前面第一次握手传过来的 seq number + 1
而它的 raw seq number 是一个另外的数字
这个 seq number 由服务端发送给客户端之后
客户端在第三次握手的报文中
携带的 raw ack number 刚好是这个数字加 1
在第三次握手的时候
就只有 ACK 标志位为 1
除了 ACK 标志位对应的值会加 1
回传之外
客户端依然会发送一个 seq number
这个 seq number
和第二次握手服务端返回的 ack number
是一样的
在 wireshark 中可以清楚的看到
第三次握手客户端发出的 raw seq number
等于第二次握手服务端发出的 raw ack number
它们的值都是 495456217
当你了解三次握手的实际过程之后
通过标志位
你就可以比较轻易地判断出
当前报文是第几次握手
SYN 为 1 ACK 为 0 是第一次握手
SYN 和 ACK 都为 1 则是第二次握手
SYN 为 0 ACK 为 1 则是第三次握手
虽然我描述的已经是比较详细了
但是可能还是有很多人不大理解
这个过程
咱今天看不懂明天还可以继续看对吧
关于标志位呢这里要着重说一下
这里全大写的就是标志位
它要么是 0 要么是 1
在 wireshark 中对标志位有比较清楚的记录
第一次握手的时候 SYN 标志位是 1
第二次握手的时候
SYN 和 ACK 标志位是 1
而第三次握手的时候
只有 ACK 标志位是 1
关于 relative seq 和 relative ack
这两个都是相对数字
在实际报文传输的时候
使用的是 raw seq 和 raw ack
来做包的排序和区分
在每次报文传输的时候
ack 都是依据前面收到的包中的 seq 计算出来的
在这个例子里面
客户端向服务器发送的报文中
相对 seq 是 1
而 raw seq 是一串数字
而这个 tcp segment Len 是 440
紧接着
客户端收到的服务端报文中
相对 ack 变成了 441
而 raw ack 这个数字刚好等于前面
发送出的 raw seq 加上 440
兄弟们现在你们应该能大概明白 ack 和 seq 的作用了吧
在前两次握手的时候
客户端和服务端
都会各自随机生成一个 raw seq
在图中实际对应的就是
SYN 标志位为 1 的时候
客户端和服务端都会发送给对方
自己随机生成的初始 seq
当收到对方发来的 seq 的时候
都需要回应对方一个 ACK
只不过对于服务端来讲
它把 SYN 和 ACK 合并到了一起
同时发给了客户端
刚才说到过
ack 等于前面收到的包中的 seq+len
这个计算方法
是在三次握手之后的计算方法
而在三次握手中 ack 都等于 seq+1
兄弟们三次握手的时候
这个计算方法它就是固定的
在 wireshark 中看到
第一次握手 TCP segment len 是 0
seq 也是 0
第二次握手发出的包中 ack 就变成了 1
另外呢还有一个规律啊
除了第一次握手和第二次握手
raw seq 是随机生成的
这之后所有发送给对方的包中
发给对方的 seq
都等于前一个包中的 ack
比如说这两个一来一回的包
客户端收到的服务端发来的包中
ack 是 839
紧接着客户端发给服务端的包中
seq 也是 839
要是你能够告诉面试官
seq 和 ack 是怎么生成和计算的
那绝对是大大的加分项啊
关于 tcp 三次握手的内容基本就这些
那个我原本以为
用一期视频就可以把三次握手
四次挥手给讲完
现在看来
下期视频才能讲四次挥手了呀
那么本期视频就到这里
咱们下期四次挥手见
