# 面试官：说一说事件循环？

- [前往视频](https://www.bilibili.com/video/BV1Qe4y1K7r3)

1
00:00:00,100 --> 00:00:01,666
js中的事件循环

2
00:00:01,666 --> 00:00:02,966
相信大家在面试的时候

3
00:00:02,966 --> 00:00:04,266
多多少少都碰到过吧

4
00:00:04,300 --> 00:00:05,766
事件循环是前端面试的时候

5
00:00:05,766 --> 00:00:07,399
出现概率非常高的一个题目

6
00:00:07,400 --> 00:00:07,866
通常呢

7
00:00:07,866 --> 00:00:09,799
面试官会抛给你一个包含了定时器

8
00:00:09,800 --> 00:00:11,566
promise和async的代码

9
00:00:11,566 --> 00:00:12,099
说真的呀

10
00:00:12,100 --> 00:00:13,733
如果是一个刚入前端的新手

11
00:00:13,733 --> 00:00:14,699
来看这些代码

12
00:00:14,700 --> 00:00:16,266
那绝对会当场蒙圈啊

13
00:00:16,266 --> 00:00:18,333
因为它考察的内容包含了定时器

14
00:00:18,333 --> 00:00:20,099
promis事件循环等等

15
00:00:20,166 --> 00:00:22,133
即便是让一个老手来回答这个问题

16
00:00:22,133 --> 00:00:23,799
他也未必能够一次全答对

17
00:00:23,800 --> 00:00:25,700
不过事件循环虽然比较绕啊

18
00:00:25,700 --> 00:00:26,900
但是在面试的时候

19
00:00:26,900 --> 00:00:29,200
考查的东西其实是非常固定的

20
00:00:29,333 --> 00:00:31,833
当你熟悉几个事件循环的常见概念之后的话

21
00:00:31,866 --> 00:00:32,899
再看这个问题

22
00:00:33,000 --> 00:00:34,166
事实上非常简单啊

23
00:00:34,166 --> 00:00:34,866
那么本期视频

24
00:00:34,866 --> 00:00:36,933
围绕面试中经常会被问到的

25
00:00:36,966 --> 00:00:39,799
async 、定时器和promise来分析事件循环

26
00:00:39,800 --> 00:00:40,766
关于事件循环

27
00:00:40,766 --> 00:00:41,899
在规范中有提到

28
00:00:41,900 --> 00:00:44,100
它是由一个或者多个任务队列构成的

29
00:00:44,100 --> 00:00:45,333
关于它具体的内部实现呢

30
00:00:45,333 --> 00:00:46,566
我们就不用去深究了

31
00:00:46,566 --> 00:00:47,366
通常情况下呢

32
00:00:47,366 --> 00:00:49,133
我们会碰到两种类型的任务队列啊

33
00:00:49,133 --> 00:00:50,199
第一种是微任务

34
00:00:50,200 --> 00:00:51,866
面试的时候给出的题目中的话

35
00:00:51,866 --> 00:00:54,566
经常就是promise.then和await后面的代码

36
00:00:54,800 --> 00:00:55,533
关于promise呢

37
00:00:55,533 --> 00:00:56,799
有一个很容易出错的点啊

38
00:00:56,800 --> 00:00:58,800
只有promise.then中的回调函数

39
00:00:58,800 --> 00:01:00,133
才会被放入到微任务中

40
00:01:00,133 --> 00:01:02,366
而promise这个构造函数的参数

41
00:01:02,366 --> 00:01:03,699
它是作为同步代码执行的

42
00:01:03,733 --> 00:01:05,266
不会被放入到任务队列中

43
00:01:05,266 --> 00:01:06,199
所以在打印的时候

44
00:01:06,200 --> 00:01:08,500
promise1是在script.end前面的

45
00:01:08,500 --> 00:01:12,233
同样的在async函数中await右边的代码也是同步代码

46
00:01:12,266 --> 00:01:12,733
也就是说

47
00:01:12,733 --> 00:01:14,766
这个async2 end会立即打印出来

48
00:01:14,766 --> 00:01:15,933
而async1 end

49
00:01:15,933 --> 00:01:17,533
则会放入到微任务队列中

50
00:01:17,766 --> 00:01:19,533
第二种任务类型是宏任务

51
00:01:19,600 --> 00:01:21,400
像setTimeout和setInterval

52
00:01:21,400 --> 00:01:22,400
它们的回调函数

53
00:01:22,400 --> 00:01:24,200
就会被放入到宏任务队列中

54
00:01:24,266 --> 00:01:26,499
关于定时器也有一些需要注意的点

55
00:01:26,533 --> 00:01:28,099
这里我们先设置了一个定时器

56
00:01:28,100 --> 00:01:29,100
它的延迟时间是0

57
00:01:29,100 --> 00:01:31,200
也就是说尽快的放入到队列中

58
00:01:31,200 --> 00:01:33,600
但是下面有一个持续2秒的while循环

59
00:01:33,600 --> 00:01:35,533
那在while循环执行的这2秒之内

60
00:01:35,533 --> 00:01:37,499
定时器中的回调函数是不会执行的

61
00:01:37,500 --> 00:01:39,266
所以打印的顺序是先打印while

62
00:01:39,266 --> 00:01:40,599
然后才打印的timeout

63
00:01:40,666 --> 00:01:41,733
那在事件循环中

64
00:01:41,733 --> 00:01:43,899
是如何处理宏任务和微任务的呢

65
00:01:43,900 --> 00:01:45,166
在一轮事件循环里面

66
00:01:45,166 --> 00:01:46,733
会只执行一个宏任务

67
00:01:46,733 --> 00:01:47,999
然后把微任务队列中的

68
00:01:48,000 --> 00:01:49,200
所有任务全部执行

69
00:01:49,200 --> 00:01:50,566
然后在下一轮循环里面

70
00:01:50,566 --> 00:01:52,133
继续只执行一个宏任务

71
00:01:52,133 --> 00:01:54,399
然后再执行微任务队列中的所有任务

72
00:01:54,733 --> 00:01:55,999
像这样说任务切换过程

73
00:01:56,000 --> 00:01:57,600
大家应该能够听得比较明白了吧

74
00:01:57,600 --> 00:01:58,166
实际上呢

75
00:01:58,166 --> 00:01:59,966
整个script标签中的代码

76
00:01:59,966 --> 00:02:01,133
它是一个宏任务

77
00:02:01,133 --> 00:02:01,966
我们可以理解成

78
00:02:01,966 --> 00:02:04,066
事件循环就是起始于这个宏任务

79
00:02:04,066 --> 00:02:06,099
那在这段宏任务代码执行过程中呢

80
00:02:06,100 --> 00:02:08,066
就会向微任务队列和宏任务队列中

81
00:02:08,066 --> 00:02:09,099
推入各种任务

82
00:02:09,166 --> 00:02:10,799
回到视频开始的这个面试题

83
00:02:10,800 --> 00:02:12,166
因为代码属实是比较长啊

84
00:02:12,166 --> 00:02:13,733
所以我把它拆分成了两个图片

85
00:02:13,733 --> 00:02:15,599
这段代码可以分成这几个过程啊

86
00:02:15,600 --> 00:02:17,933
首先是会立即打印的script start

87
00:02:17,933 --> 00:02:19,466
然后是async函数部分

88
00:02:19,466 --> 00:02:20,733
紧接着是两个定时器

89
00:02:20,733 --> 00:02:23,299
然后是new Promise后面还跟着两个 .then

90
00:02:23,300 --> 00:02:25,300
最后是同步代码script end

91
00:02:25,500 --> 00:02:27,400
最开始的script start打印之后

92
00:02:27,400 --> 00:02:28,866
就会执行async1函数

93
00:02:28,866 --> 00:02:31,266
在async1中呢又会先执行async2

94
00:02:31,266 --> 00:02:33,366
所以紧接着会打印async2 end

95
00:02:33,366 --> 00:02:34,966
而async2执行之后

96
00:02:34,966 --> 00:02:35,999
await后面的代码

97
00:02:36,000 --> 00:02:37,500
会放入到微任务队列中

98
00:02:37,500 --> 00:02:39,733
在当前代码执行完成之后才会执行

99
00:02:39,766 --> 00:02:41,466
我们给它先打一个微任务的标记

100
00:02:41,466 --> 00:02:42,733
接下来是两个定时器

101
00:02:42,733 --> 00:02:44,199
这两个定时器中的回调函数

102
00:02:44,200 --> 00:02:45,766
会被放入到宏任务队列中

103
00:02:45,766 --> 00:02:47,566
这里给他们打上宏任务的标记

104
00:02:48,200 --> 00:02:50,300
Promise构造函数中的代码是同步代码

105
00:02:50,300 --> 00:02:52,500
所以会立即打印promise1和promise2

106
00:02:52,500 --> 00:02:53,933
而这两个.then中的回调函数呢

107
00:02:53,933 --> 00:02:55,366
会被放入到微任务队列中

108
00:02:55,366 --> 00:02:57,333
紧接着碰到最后的这个console.log

109
00:02:57,333 --> 00:02:58,733
会打印出script end

110
00:02:58,733 --> 00:03:00,099
当前的任务就执行完了

111
00:03:00,100 --> 00:03:01,533
那么微任务队列中的三个任务

112
00:03:01,533 --> 00:03:02,466
也会被执行掉

113
00:03:02,666 --> 00:03:04,933
所以按照顺序会先打印出async1 end

114
00:03:04,933 --> 00:03:06,799
然后是promise3和promise4

115
00:03:06,800 --> 00:03:08,366
接下来是两个宏任务

116
00:03:08,366 --> 00:03:10,666
先执行第一个定时器中的回调函数

117
00:03:10,666 --> 00:03:11,899
碰到一个console.log

118
00:03:11,900 --> 00:03:13,466
所以打印出setTimeout1

119
00:03:13,666 --> 00:03:16,199
紧接着好巧不巧又碰到了一个promise

120
00:03:16,200 --> 00:03:17,866
那肯定是要把这两个回调函数

121
00:03:17,866 --> 00:03:19,066
推到微任务队列中了

122
00:03:19,066 --> 00:03:21,333
等定时器这个回调函数执行完成之后呢

123
00:03:21,333 --> 00:03:22,333
内部检查的时候

124
00:03:22,333 --> 00:03:24,133
发现微任务队列中有任务

125
00:03:24,133 --> 00:03:24,899
所以就切换

126
00:03:24,900 --> 00:03:26,566
去执行微任务队列中的任务了

127
00:03:26,600 --> 00:03:29,866
接着就打印出了promise in timer1和promise in timer2

128
00:03:29,866 --> 00:03:30,866
最后是只剩下

129
00:03:30,866 --> 00:03:32,499
第二个定时器中的宏任务了

130
00:03:32,500 --> 00:03:35,200
所以最后一个打印出来的才是setTimeout2

131
00:03:35,200 --> 00:03:36,666
兄弟们这么绕的一个题目

132
00:03:36,666 --> 00:03:38,266
就是这样慢慢推出来的

133
00:03:38,266 --> 00:03:40,699
不知道各位兄弟们错了多少啊

134
00:03:41,100 --> 00:03:44,133
关于在promise.then再分别推入宏任务的话

135
00:03:44,133 --> 00:03:45,299
它的结果是怎么样的呢

136
00:03:45,300 --> 00:03:47,200
要是碰到面试官问这种问题

137
00:03:47,200 --> 00:03:48,733
兄弟们要不咱不受这个气

138
00:03:48,733 --> 00:03:50,099
直接转头就走

139
00:03:50,133 --> 00:03:52,066
这种代码属实是极其的绕啊

140
00:03:52,066 --> 00:03:53,199
但是这里有一个好消息

141
00:03:53,200 --> 00:03:54,700
就是它的结果非常简单

142
00:03:54,766 --> 00:03:55,399
这几个微任务

143
00:03:55,400 --> 00:03:57,733
全部会在定时期中的宏任务执行之前

144
00:03:57,733 --> 00:03:58,166
执行

145
00:03:58,166 --> 00:04:00,366
所以promise3-promise6是先打印出来

146
00:04:00,366 --> 00:04:01,099
然后再打印的

147
00:04:01,100 --> 00:04:02,733
setTimeout3-setTimeout6

148
00:04:02,733 --> 00:04:03,733
我们可以简单理解成

149
00:04:03,733 --> 00:04:04,933
这几个.then中的回调函数

150
00:04:04,933 --> 00:04:06,733
会被一次性的推到微任务队列中

151
00:04:06,733 --> 00:04:08,699
所以这4个微任务会先执行

152
00:04:08,700 --> 00:04:10,800
然后才是执行定时器中的回调函数

153
00:04:10,800 --> 00:04:12,366
好了本期视频到这里就结束了

154
00:04:12,366 --> 00:04:14,033
感谢大家的观看拜拜

